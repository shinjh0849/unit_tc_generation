# Replication pakage for Domain Adaptation for Deep Unit Test Case Generation


## Dataset
All the dataset for evaluation (both input and output files for the models) is in ```dataset``` folder.

1. The input dataset of evaluation used in our experiment is in ```dataset/defects4j``` folder.
    
    ```*.methods``` files are the input files for the models.
    
    ```*.tests``` files are the output files for the models, i.e. ground truth files.

    ```*info_0.txt``` files includes additional info for each instances, e.g. line #, path name of focal class and test class.

2. Also output, or the generated test cases from each baseline is provided

    ```dataset/a3test``` contains the test cases generated by the method A3Test.
    
    ```dataset/gpt4``` contains the input/ground truth/info used for GPT-4 and the test cases generated by the method GPT-4.

    ```dataset/codet5/noda``` contains the test cases generated by the method CodeT5 witout DA.

    ```dataset/codet5/da``` contains the test cases generated by the method CodeT5 with DA.

## Context extraction 
For extracting the context for any java project you can copy the ```src``` folder of your project in the ```extract_context/input``` folder.

Then run the java package provided in ```extract_context```. You can use any editor (preferably intellij).

The extracted context will be in the ```output``` folder.

## Coverage 
After using clover for getting the coverage of your java project, clover will generate a number of database files with names starting with ```*clover4_4_1.db*.```.

Copy all of them to ```*coverage/src/main/java/Projects*``` and run the provided java project for reading the database.

The provided code will generate a line-to-test-mapping file (e.g. ```Lang1f_line2test.txt```).

You will use it for generating the dataset in the next step.

## Line2test

For generating the dataset for your project, you should copy the generated context (consisting ```context``` ```method_names``` ```methods``` folders), line2test file (e.g. ```Lang1f_line2test.txt```) and the src code of your project in this folder.

After copying everything you can edit the ```line2test.py``` for your project.

All defects4j projects are available in the code just uncomment the project config available in ```line2test.py```.


## CodeT5
For training the CodeT5 model you can copy the generated data in ```*code_t5/data/test_gen*``` folder and use the ```*code_t5/sh/train.sh*``` scripts for training the model. 

## Post_processing 
After generating the tests for each project you should use post-processing in order to select the compilable tests. 

You can edit ```*convert_model_output_to_tests.py*``` and ```*select_runnable_tests.py*``` for the project under test.

Then you should run the ```*convert_model_output_to_tests.py*``` first.

Then you run ```*select_runnable_tests.py*``` and the ready to run tests will be generated in ```*post_processing/out/combined*```.

The ```*post_processing/combined*``` folder is the result of all projects. 

Then you can copy the tests from combined folder to your java project and calculate the coverage. 

The coverage of model generated tests can be found in ```*post_processing/model_gen_coverage*``` folder for each project.

## GPT-4
We also provide the scripts we used to prompt GPT-4.

After swapping your organization and API key in the code, run the python file:
```
python gpt_4.py
```

## A3Test
To run A3Test with our dataset, first clone their [replication package](https://github.com/awsm-research/a3test).

Then follow the pre-installation guide in their README.

We directly used their trained weights and bias in their hugging face [distribution](https://github.com/awsm-research/A3Test/tree/main).

Import the model and follow their guide in testing A3Test model:
```
python testScript.py -i model.pth -t test.csv -a test.txt -q Defect4jTests.txt
```

Following is the parameter explanation from their package.
```
parser.add_argument("-i", "--modelInput", dest="modelInput", help="Saved Model file for the testing the script")
parser.add_argument("-t", "--testInput", dest="testInput", help="Test Input file for the model accuracy")
parser.add_argument("-a","--externalTestFile", dest="externalTestFile", help="External Test Files for generating the UTs")
parser.add_argument("-q","--externalTestFileOutput", dest="externalTestFileOutput", help="External Test Files output for generating the UTs")
```